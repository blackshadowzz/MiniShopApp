@page "/orders/views"
@layout MainLayout
@using MiniShopApp.Models.Orders
@using MiniShopApp.Shared.AdditionalServices
@using MiniShopApp.Shared.DropdownActions
@inject PdfService pdfService

<PageTitle>Views Order</PageTitle>
<MudPaper Elevation="2" >
     <DropdownActionOrder 
            ExpandedAction="_expandedEdit"
                         ItemCount="@selectedOrders.Count"
                         ClickPrint="@(() => GenerateReceiptAsync(selectedOrders))" />

    <MudTable ServerData="ServerReload" 
        T="ViewTbOrders" 
        MultiSelection=true 
        Dense="true" 
        Hover="true"
        Context="context"
              FixedHeader=fixed_header
              FixedFooter=fixed_footer
              Height="@(fixed_header || fixed_footer ?"500px":"")"
        @ref="table" 
        Loading="isLoading" 
        SelectOnRowClick=false
              SelectedItemsChanged="@(items => MultiSelect(items))"
        LoadingProgressColor="Color.Primary" OnRowClick="OnExpandCollapseClick">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Order Summary</MudText>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s=>OnSearch(s))" Placeholder="Search" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        <MudSpacer />
        <MudStack Row=true Justify="Justify.FlexEnd" AlignItems="AlignItems.Center">
                <MudDatePicker 
                    @bind-Date="startDate" 
                    Label="Start Date" 
                    Margin="Margin.Dense" 
                    Variant="Variant.Text" 
                    Clearable=true
                    Class="mx-2" 
                    OnClick="@(() => OnDateChanged(startDate))" />
                <MudDatePicker 
                    @bind-Date="endDate" 
                    Label="End Date"
                               Clearable=true
                               Margin="Margin.Dense" 
                    Variant="Variant.Text" 
                    Class="mx-2" 
                    OnClick="@(() => OnDateChanged(endDate))" />
                <MudSelect T="int?" @bind-Value="selectedMonth" Label="Month" Style="width:110px"  Margin="Margin.Dense" Class="" >
                    <MudSelectItem T="int?" Value="null">All</MudSelectItem>
                    @for (var m = 1; m <= 12; m++)
                    {
                        var mon = @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m);
                        <MudSelectItem T="int?" Value="@m">@mon</MudSelectItem>
                    }
                </MudSelect>
                <MudSelect T="int?" @bind-Value="selectedYear" Label="Year" Style="width:110px" Margin="Margin.Dense" Class="">
                    <MudSelectItem T="int?" Value="null">All</MudSelectItem>
                    @foreach (var y in yearsList)
                    {
                        <MudSelectItem T="int?" Value="y">@y</MudSelectItem>
                    }
                </MudSelect>
                <MudStack>
                    <MudButton OnClick="@(() => OnDateChanged(endDate))"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.FilterList"
                               Variant="Variant.Outlined"
                               Color="Color.Success">Filter</MudButton>
                </MudStack>
                
                <MudMenu Label="Export" Variant="Variant.Filled" Size="Size.Small" Color="Color.Info" EndIcon="@Icons.Material.Filled.FileDownload">
                    <MudMenuItem Label="Export Excel" OnClick="ExportToExcel" IconColor="Color.Success" Icon="@Icons.Material.Filled.FileDownload" />
                    <MudMenuItem Label="Export PDF" OnClick="ExportToPdf" IconColor="Color.Error" Icon="@Icons.Material.Filled.PictureAsPdf" />

                </MudMenu>
               
        </MudStack>
           
                       
    </ToolBarContent>

        <HeaderContent>
            <MudTh>
                <MudTableSortLabel SortLabel="Id" T="ViewTbOrders">
                 Date
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Id" T="ViewTbOrders">
                    Customer Id
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Id" T="ViewTbOrders">
                    Customer
                </MudTableSortLabel>
                </MudTh>
            <MudTh>Table</MudTh>
            <MudTh>Item</MudTh>
            <MudTh>Price</MudTh>
            <MudTh>Discount</MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="Id" T="ViewTbOrders">
                    Total
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd @key="context.Id" DataLabel="Order ID"><MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" /> @context.CreatedDT?.ToString("dd/MMM/yy")</MudTd>
            <MudTd DataLabel="CustomerId">@context.CustomerId</MudTd>
            <MudTd DataLabel="FirstName">@context.FirstName</MudTd>
            <MudTd DataLabel="TableNumber">@context.TableNumber</MudTd>
            <MudTd DataLabel="ItemCount">@context.ItemCount</MudTd>
            <MudTd DataLabel="SubPrice">@context.SubPrice?.ToString("c2")</MudTd>
            <MudTd DataLabel="DiscountPrice">@context.DiscountPrice?.ToString("P0")</MudTd>
            <MudTd DataLabel="TotalPrice">@context.TotalPrice?.ToString("c2")</MudTd>
        </RowTemplate>
        <ChildRowContent>

            <MudTd ColSpan="9" Class="bg-body-tertiary" hidden="@(_expandedOrderId != context.Id)" DataLabel="Order details" HideSmall="true">
                <MudCollapse Expanded="_expandedOrderId == context.Id" Tag="@context.Id">
                    <MudTable Items="@context.TbOrderDetails" Dense=true Hover=false Context="c">
                        <HeaderContent>
                            <MudTh>Id</MudTh>
                            <MudTh>Item</MudTh>
                            <MudTh>Quantity</MudTh>
                            <MudTh>Price</MudTh>
                            <MudTh>Total Price</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@c.Id</MudTd>
                            <MudTd>@c.ItemName</MudTd>
                            <MudTd>@c.Quantity</MudTd>
                            <MudTd>@c.Price?.ToString("c2")</MudTd>
                            <MudTd>@c.TotalPrice?.ToString("c2")</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCollapse>
            </MudTd>

        </ChildRowContent>
        
        <NoRecordsContent>
            <MudText>No matching records found</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Loading...</MudText>
        </LoadingContent>
        <FooterContent>
            <MudTd colspan="7"></MudTd>
            <MudTd><b>@(pagedData?.Sum(x => x.TotalPrice)?.ToString("c2") ?? "0.00")</b></MudTd>
        </FooterContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
    <MudStack Row=true StretchItems="StretchItems.None">
        <MudCheckBox @bind-Value="fixed_header" Color="Color.Primary">Fixed Header</MudCheckBox>
        <MudCheckBox @bind-Value="fixed_footer" Color="Color.Primary">Fixed Footer</MudCheckBox>
    </MudStack>
</MudPaper>


@code{
    bool fixed_header = true;
    bool fixed_footer = true;
    long? _expandedOrderId = null;
    bool isVisibe = true;
    private void OnExpandCollapseClick(TableRowClickEventArgs<ViewTbOrders> row)
    {
        if (_expandedOrderId == row.Item.Id)
        {
            isVisibe = true;

            _expandedOrderId = null; // Collapse if already expanded
        }
        else
        {
            isVisibe = false;
            _expandedOrderId = row.Item.Id; // Expand this row

        }
    }
    private IEnumerable<ViewTbOrders> pagedData;
    private MudTable<ViewTbOrders> table;

    private int totalItems;
    private string searchString = null;
    private DateTime? startDate = null;
    private DateTime? endDate = null;
    private int? selectedMonth = null;
    private int? selectedYear = null;
    private List<int> yearsList = new();

    private List<ViewTbOrders> selectedOrders = new();
    bool _expandedEdit = false;
    void MultiSelect(IEnumerable<ViewTbOrders> items)
    {
        selectedOrders = items.ToList();
        if (selectedOrders.Any())
            _expandedEdit = true;
        else
            _expandedEdit = false;

        StateHasChanged();
    }
    protected override void OnInitialized()
    {
        // Populate yearsList from orders or a reasonable range
        var minYear = orders.Min(o => o.CreatedDT?.Year) ?? DateTime.Now.Year;
        var maxYear = orders.Max(o => o.CreatedDT?.Year) ?? DateTime.Now.Year;
        for (int y = minYear; y <= maxYear; y++)
        {
            yearsList.Add(y);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("import", "/blazorDownloadFile.js");
        }
    }

    /// <summary>
    /// Here we simulate getting the paged, filtered and ordered data from the server
    /// </summary>
    private async Task<TableData<ViewTbOrders>> ServerReload(TableState state, CancellationToken token)
    {
        IEnumerable<ViewTbOrders> data = orders;
        await Task.Delay(300, token);
        data = data.Where(element =>
        {
            bool matches = true;
            if (!string.IsNullOrWhiteSpace(searchString))
            {
                matches = element.CustomerId.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase)
                    || (element.TableNumber != null && element.TableNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                    || (element.LastName != null && element.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                    || (element.Id.ToString() != null && element.Id.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase))
                    || (element.FirstName != null && element.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase));
            }
            if (matches && startDate.HasValue)
            {
                matches = element.CreatedDT.HasValue && element.CreatedDT.Value.Date >= startDate.Value.Date;
            }
            if (matches && endDate.HasValue)
            {
                matches = element.CreatedDT.HasValue && element.CreatedDT.Value.Date <= endDate.Value.Date;
            }
            if (matches && selectedMonth.HasValue)
            {
                matches = element.CreatedDT.HasValue && element.CreatedDT.Value.Month == selectedMonth.Value;
            }
            if (matches && selectedYear.HasValue)
            {
                matches = element.CreatedDT.HasValue && element.CreatedDT.Value.Year == selectedYear.Value;
            }
            return matches;
        }).ToArray();
        totalItems = data.Count();
        switch (state.SortLabel)
        {
            case "Id":
                data = data.OrderByDirection(state.SortDirection, o => o.Id);
                break;
            case "CustomerId":
                data = data.OrderByDirection(state.SortDirection, o => o.CustomerId);
                break;
            case "TableNumber":
                data = data.OrderByDirection(state.SortDirection, o => o.TableNumber);
                break;
            case "FirstName":
                data = data.OrderByDirection(state.SortDirection, o => o.FirstName);
                break;
            case "TotalPrice":
                data = data.OrderByDirection(state.SortDirection, o => o.TotalPrice);
                break;
           
        }

        pagedData = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
        return new TableData<ViewTbOrders>() { TotalItems = totalItems, Items = pagedData.OrderByDescending(x=>x.Id) };
    }

    private void OnSearch(string text)
    {
        searchString = text;
        table.ReloadServerData();
    }

    private void OnDateChanged(DateTime? date)
    {
        table.ReloadServerData();
    }

    private void OnMonthOrYearChanged(object value)
    {
        table.ReloadServerData();
    }
    private async Task GenerateReceiptAsync(IEnumerable<ViewTbOrders> orders)
    {
        foreach (var order in orders)
        {

            var pdfBytes = pdfService.CreateOrderReceiptPdf(order);
            var base64 = Convert.ToBase64String(pdfBytes);
            await JS.InvokeVoidAsync("DownloadReceipt", $"receipt_{order.Id}.pdf", "application/pdf", base64);
        }
    }
}