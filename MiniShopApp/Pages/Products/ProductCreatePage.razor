@page "/products/create"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MiniShopApp.Data.TelegramStore


@rendermode InteractiveServer
@layout MainLayout
@inject UserState userState


<PageTitle>Create Product</PageTitle>

<MudForm @ref="form">
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Class="p-4">
                <MudTextField @bind-Value="@model.ProductCode" Label="Product Code" Variant="Variant.Outlined" Required="true"/>
                <MudTextField @bind-Value="@model.ProductName" Label="Product Name" Variant="Variant.Outlined" Required="true" />
                <MudTextField @bind-Value="@model.Description" Label="Description" Variant="Variant.Outlined" />
                <MudNumericField @bind-Value="@model.Price" Label="Price" TValue="double?" Variant="Variant.Outlined" />
                <MudNumericField @bind-Value="@model.SubPrice" Label="Subprice" TValue="double?" Variant="Variant.Outlined" />
                <MudSelect T="int?" @bind-Value="@model.CategoryId" Label="Select Category" Variant="Variant.Outlined" Required="true">
                    @foreach (var cat in categories)
                    {
                        <MudSelectItem Value="@cat.CategoryId">@cat.CategoryName</MudSelectItem>
                    }
                </MudSelect>
                <MudSpacer />
                <MudFileUpload T="IBrowserFile" OnFilesChanged="@HandleFileSelected" ma accept=".jpg,.jpeg,.png" Class="mt-2">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload">
                            Upload Files
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
                <MudItem Class="d-flex justify-content-end mt-5">
                    <MudButton Variant="Variant.Filled"
                               Href="/products" Class="mt-2">
                        Back to list
                    </MudButton>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="@CreateProduct" Class="mt-2">
                        Submit
                    </MudButton>
                </MudItem>
                
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex justify-center align-center">
            <MudCard Style="max-width:400px" >
                @if (!string.IsNullOrEmpty(imagePreviewUrl))
                {
                        <MudCardMedia Image="@imagePreviewUrl" Height="200"  />
                        
                }
                <MudCardContent>
                    <MudText Typo="Typo.body1">
                        @if(isLoading)
                        {
                            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                        }
                        else if (string.IsNullOrEmpty(imagePreviewUrl))
                        {
                            <span>No image selected</span>
                        }
                        else
                        {
                            <span>Image preview loaded</span>
                        }

                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

    </MudGrid>


</MudForm>

<p class="">User Id: @userId</p>
@code{
    private IBrowserFile selectedFile;
    private string imagePreviewUrl;
    bool isLoading = false;
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        

        try
        {
            const int maxWidth = 1024;
            const int maxHeight = 768;
            await using var stream = e.File.OpenReadStream();
            using var image = await SixLabors.ImageSharp.Image.LoadAsync(stream);

            if (image.Width > maxWidth || image.Height > maxHeight)
            {
                Console.WriteLine("Image resolution too large.");
                // Show error or prevent saving
                SnackbarService.Add("Image resolution exceeds maximum allowed size.", Severity.Error);
                return;
            }
            isLoading = true;

            selectedFile = e.File;
            // Preview: Convert to Base64 data URL
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream().ReadAsync(buffer);

            var ext = Path.GetExtension(selectedFile.Name).ToLowerInvariant();
            var mimeType = ext switch
            {
                ".jpg" or ".jpeg" => "image/jpeg",
                ".png" => "image/png",
                _ => "application/octet-stream"
            };

            imagePreviewUrl = $"data:{mimeType};base64,{Convert.ToBase64String(buffer)}";
            isLoading = false;
        }catch (Exception ex)
        {
            isLoading = false;
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            return;
        }
        finally
        {
            StateHasChanged();
            isLoading = false;
        }

    }
    private async Task<bool> HandleValidSubmit()
    {
        if (selectedFile is not null)
        {
            var uploadsFolder = Path.Combine("wwwroot", "images", "products");
            Directory.CreateDirectory(uploadsFolder); // Ensure folder exists

            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(selectedFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            await using var stream = File.Create(filePath);
            await selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);

            // Set relative URL for DB
            model.ImageUrl = $"images/products/{fileName}";
            return true;
        }
        Snackbar.Add("Please select a file.", Severity.Error);
        return false;

        // Insert newProduct into the database here (e.g., via EF Core)
    }

}
